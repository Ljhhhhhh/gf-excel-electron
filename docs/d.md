# 地方金融组织融资借贷类（商业保理）统计表

### 1. 统计期间输入（period）

使用此报表模板时，用户需要传入一个字符串类型的“统计期间”参数 `period`，用于后续数据筛选。支持以下三种格式：

1. **月度：** `YYYYMM`
   - 例如：`202501` 表示 2025 年 1 月。
2. **季度：** `YYYYQn`
   - 例如：`2025Q1` 表示 2025 年第 1 季度（1–3 月）。
3. **年度：** `YYYY`
   - 例如：`2025` 表示 2025 年全年。

### 2. 统计维度变量（span）

根据 `period` 的格式，需要在模板数据中增加一个变量 `span`，用于表示当前报表的统计维度。约定如下：

- 当 `period` 为 `YYYYMM` 格式时：
  - `span = "月"`
- 当 `period` 为 `YYYYQn` 格式时：
  - `span = "季"`
- 当 `period` 为 `YYYY` 格式时：
  - `span = "年"`

### 3. 统计期间展示格式变量（queryFormat）

新增变量 `queryFormat`，用于在报表中以中文形式展示当前统计条件。格式规则如下：

- 若 `period` = `YYYYMM`：
  - 例如 `period = "202501"`
  - `queryFormat = "2025年1月"`
  - 即年份 + “年” + 去掉前导零的月份 + “月”
- 若 `period` = `YYYYQn`：
  - 例如 `period = "2025Q1"`
  - `queryFormat = "2025年第一季度"`
  - Q1/Q2/Q3/Q4 分别对应 “第一季度 / 第二季度 / 第三季度 / 第四季度”
- 若 `period` = `YYYY`：
  - 例如 `period = "2025"`
  - `queryFormat = "2025年"`

### 4. “属于统计期间”的统一定义

后续所有统计指标中出现的“P 列（实际放款日期）属于统计期间”统一定义为：

- 将放款明细表 P 列日期解析出年份与月份（Y、M）；
- 根据 `span` 的不同，判断包含关系：

1. **`span = "month"`（月度）**
   - `period` = `YYYYMM`
   - 仅保留满足：
     - 年份 = `YYYY`
     - 月份 = `MM`

       的记录。

2. **`span = "quarter"`（季度）**
   - `period` = `YYYYQn`，其中 n ∈ {1,2,3,4}
   - 季度与月份对应关系：
     - Q1：1–3 月
     - Q2：4–6 月
     - Q3：7–9 月
     - Q4：10–12 月
   - 仅保留满足：
     - 年份 = `YYYY`
     - 月份 ∈ 当季对应的月份集合

       的记录。

3. **`span = "year"`（年度）**
   - `period` = `YYYY`
   - 仅保留满足：
     - 年份 = `YYYY`

       的记录。

---

## 二、总表（【总表】工作表）

【总表】工作表中，需要从放款明细表中计算并填充以下几个变量（注意：**已取消 ytd\_ 前缀**）：

### 1. `summary.total_business_amount`

**计算规则：**

- 从放款明细表中，筛选出 P 列（实际放款日期）**属于统计期间**的所有行；
- 对这些行的 AW 列（放款金额）求和；
- 将求和结果 **除以 10000**，得到单位为“万元”的金额。

> 含义：当前统计期间内的发放业务金额合计（万元）。

---

### 2. `summary.agri_small_business_amount`

**计算规则：**

- 从放款明细表中，筛选出满足以下条件的行：
  - P 列（实际放款日期）属于统计期间；
  - 且 F 列（企业规模）字段值为 **“小型”** 或 **“微型”**。
- 对这些行的 AW 列（放款金额）求和；
- 将求和结果 **除以 10000**，得到单位为“万元”的金额。

> 含义：当前统计期间内，小微企业发放业务金额合计（万元）。

---

### 3. `summary.served_customer_count`

**计算规则：**

- 从放款明细表中，筛选出 P 列（实际放款日期）属于统计期间的所有行；
- 取这些行的 C 列（保理/再保理申请人名称）；
- 对 C 列值进行**去重**；
- 剔除空值（空字符串、null 等不代表有效客户名称的值）；
- 统计去重后非空客户名称的个数。

> 含义：当前统计期间内实际服务的客户数量（按申请人名称去重）。

---

## 三、保理表（【保理】工作表）

【保理】工作表中，需要从放款明细表中计算并填充以下变量（同样已取消 ytd\_ 前缀）：

### 1. `factoring.financing_factoring_business_amount`

**计算规则：**

- 从放款明细表中，筛选出 P 列（实际放款日期）属于统计期间的所有行；
- 对这些行的 AW 列（放款金额）求和；
- 将求和结果 **除以 10000**，得到单位为“万元”的金额。

> 含义：当前统计期间内，融资性保理业务发放金额合计（万元）。

> 说明：如果业务上“总表中的总业务金额”和“保理中的融资保理业务金额”有所区别，可在源数据中加以区分；若无区分，则这两个值可能相同。

---

### 2. `factoring.agri_small_factoring_business_amount`

**计算规则：**

- 从放款明细表中，筛选出满足以下条件的行：
  - P 列（实际放款日期）属于统计期间；
  - 且 F 列（企业规模）字段值为 **“小型”** 或 **“微型”**。
- 对这些行的 AW 列（放款金额）求和；
- 将求和结果 **除以 10000**，得到单位为“万元”的金额。

> 含义：当前统计期间内，小微企业融资性保理业务发放金额合计（万元）。

---

### 3. `factoring.factoring_contract_count`

**计算规则：**

- 从放款明细表中，筛选出 P 列（实际放款日期）属于统计期间的所有行；
- 取这些行的 N 列值（假定为“保理合同编号”或等价的合同标识字段，请以实际字段定义为准）；
- 对 N 列值进行**去重**；
- 剔除空值（不代表有效合同编号的值）；
- 统计去重后非空合同编号的个数。

> 含义：当前统计期间内融资性保理业务合同笔数（按合同编号去重）。

---

## 四、小结：需要输出/可用的关键变量列表

最终，这个模板需要在 carbone/生成引擎中可用的变量主要包括：

- **输入/派生变量：**
  - `period`：用户输入的统计期间（字符串），格式为 `YYYYMM` / `YYYYQn` / `YYYY`
  - `span`：统计维度，`"月" | "季" | "年"`
  - `queryFormat`：当前统计条件的中文展示形式，例如：
    - `202501` → `2025年1月`
    - `2025Q1` → `2025年第一季度`
    - `2025` → `2025年`
- **总表统计变量（summary.\*）：**
  - `summary.total_business_amount`
  - `summary.agri_small_business_amount`
  - `summary.served_customer_count`
- **保理统计变量（factoring.\*）：**
  - `factoring.financing_factoring_business_amount`
  - `factoring.agri_small_factoring_business_amount`
  - `factoring.factoring_contract_count`
