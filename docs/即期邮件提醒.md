一、数据源

本报表处理涉及 3 份 Excel 文件，且每个文件均使用其第一张工作表（例如 Sheet1）：

- 《即期提醒融资列表》
- 《放款明细》
- 《通商回款邮件提醒信息采集》

以下描述中提到的各表，默认均指代上述文件的第一张工作表。

---

二、数据准备与回填逻辑

1. 在《即期提醒融资列表》中新增列标题（第 1 行）：
   - O1：出款银行
   - P1：应收账款转让金额
   - Q1：放款金额
   - R1：客户管理员邮箱
   - S1：业务经理邮箱
   - T1：业务负责人邮箱
   - U1：客关对接人邮箱

2. 在《即期提醒融资列表》中筛选资产编号集合
   - 在《即期提醒融资列表》中，筛选 A 列“即期逾期天数（工作日）”等于 0、-1、-5 或 -10 的行；
     （按数值判断，非数值或空值视为不满足条件，排除）
   - 记录这些行的 H 列“放款流水号”，后续用于到《放款明细》中匹配。

3. 在《放款明细》中匹配资产编号并回填银行及金额信息

   在《放款明细》中，按以下逻辑处理：

   3.1 放款流水号匹配与“通商”筛选
   - 根据第 2 步得到的放款流水号集合，筛选出 M 列“放款流水号”等于这些流水号的所有行；
   - 在上述结果中，进一步筛选出 U 列“放款账户开户行”文本中 **包含“通商”** 的行：
     - 采用子串匹配；
     - 不区分大小写（例如“宁波通商银行股份有限公司”视为包含“通商”）。

       3.2 多条匹配记录的处理约定

   - 对于每一个放款流水号，假定在《放款明细》中最多只有一条 U 列包含“通商”的记录；
   - 若实际存在多条符合条件的记录，则 **只取其中第一条** 作为该放款流水号的匹配结果。

     3.3 回填至《即期提醒融资列表》

   - 对于第 2 步中记录的每一个资产编号：
     - 在《放款明细》中找到对应的匹配记录（按上一步逻辑）；
     - 在《即期提醒融资列表》中找到 H 列“放款流水号”等于该流水号的所有行；
     - 将匹配到的放款明细字段回填到这些行中：
       - 将《放款明细》U 列“放款账户开户行”填入 O 列“出款银行”；
       - 将《放款明细》AR 列“转让总金额”填入 P 列“应收账款转让金额”；
       - 将《放款明细》AW 列“放款金额”填入 Q 列“放款金额”。

   - 若某放款流水号在《放款明细》中 **没有找到** U 列包含“通商”的记录：
     - 则《即期提醒融资列表》中该放款流水号对应行的 O/P/Q 列保持为空。

4. 从《通商回款邮件提醒信息采集》中补齐邮箱字段

   在《即期提醒融资列表》中：
   - 筛选出 O 列“出款银行”不为空的所有行；
   - 对这些行，取 C 列“客户名称”；
   - 在《通商回款邮件提醒信息采集》中，根据 A 列“客户名称”查找同名的行：
     - 假定每个客户名称在该表中最多出现一行；
     - 若存在多行匹配，则 **仅取匹配到的第一行** 作为该客户的邮箱信息来源。

   将“邮件采集表”中的邮箱字段回填至《即期提醒融资列表》中相同客户名称的行（所有该客户名称的行都填同样的邮箱）：
   - B 列 → 填入 R 列“客户管理员邮箱”
   - D 列 → 填入 S 列“业务经理邮箱”
   - F 列 → 填入 T 列“业务负责人邮箱”
   - H 列 → 填入 U 列“客关对接人邮箱”

   至此，《即期提醒融资列表》中：
   - A 列属于 0 / -1 / -5 / -10；
   - 且 O 列“出款银行”不为空；

   的行，即为后续生成邮件提醒报表所需的完整数据行。

---

三、Carbone 模板与 JSON 数据结构

5. 使用 emailNotify.xlsx 作为 Carbone 模板，生成最终 Excel 文件
   - 模板文件：`emailNotify.xlsx`（已预设 Carbone 标记）；
   - 输出文件：基于当前日期生成文件名，格式为：
     `即期提醒汇总_YYYYMMDD.xlsx`
     例如：`即期提醒汇总_20250301.xlsx`。

   向 Carbone 提供的数据为一个包含 `reports` 数组的 JSON 对象，构造规则如下。

5.1 数据过滤与分组逻辑

- **过滤条件**：仅使用《即期提醒融资列表》中满足以下条件的行：
  - O 列“出款银行”不为空。
- **分组依据**：按 C 列“客户名称”进行分组；
  - 以 C 列“客户名称”的唯一值为 key，将行划分为多个分组。
- **reports 数组构造**：
  - 每一个唯一的“客户名称”，生成 `reports` 数组中的一个对象（对应模板中的一个 Sheet 实例）；
  - 同一客户名下的多行数据，按其在《即期提醒融资列表》中的原始行顺序，放入该对象的 `transactions` 数组。

  5.2 JSON 根结构
  提供给 Carbone 的 JSON 根结构为：

```json
{
  "reports": [
    {
      "clientName": "...",
      "clientAdminEmail": "...",
      "managerEmail": "...",
      "headEmail": "...",
      "contactEmail": "...",
      "transactions": [
        {
          "buyerName": "...",
          "assetNo": "...",
          "arTransferAmount": ...,
          "arDueDate": "...",
          "loanSerialNo": "...",
          "loanAmount": ...,
          "financingDueDate": "...",
          "repaymentAmount": ...
        },
        ...
      ]
    },
    ...
  ]
}
```

    - `reports`：数组，每个元素对应一个客户（一个工作表）；
    - 每个 `report` 对象包含：
        - 头部信息字段（clientName 等）；
        - 明细数组 `transactions`（该客户名下的所有行）。

5.3 字段映射规范（Mapping Schema）

5.3.1 头部信息字段（每个 report 对象的一般属性）

每个分组（同一客户名称）内，取该分组中 **第一条记录** 的相关列作为头部信息（假定同一客户的这些信息一致）：

| JSON 字段名 (Target) | 源数据列 (Source) | 业务含义       | 对应模板位置        |
| -------------------- | ----------------- | -------------- | ------------------- |
| `clientName`         | C 列              | 客户名称       | B1，且用作 Sheet 名 |
| `clientAdminEmail`   | R 列              | 客户管理员邮箱 | B2                  |
| `managerEmail`       | S 列              | 业务经理邮箱   | B3                  |
| `headEmail`          | T 列              | 业务负责人邮箱 | B4                  |
| `contactEmail`       | U 列              | 客关对接人邮箱 | B5                  |

> 说明：
>
> - Sheet 名建议使用 `clientName`，如存在非法字符可在代码层按规则替换。
> - 若同一客户名称在多行中出现的邮箱字段存在不一致，以分组内第一条记录为准。

5.3.2 明细列表字段（每个 report 对象下的 `transactions` 数组）

对该客户名下的所有符合条件的行（过滤 + 分组后），依原始行顺序映射为 `transactions` 数组中的对象，每一行对应一个 transaction。字段映射如下：

| JSON 字段名 (Target) | 源数据列 (Source) | 业务含义         | 对应模板位置      |
| -------------------- | ----------------- | ---------------- | ----------------- |
| `buyerName`          | D 列              | 基础交易对手方   | B7 起（按行递增） |
| `assetNo`            | F 列              | 资产编号         | C7 起（按行递增） |
| `arTransferAmount`   | P 列              | 应收账款转让金额 | D7 起（按行递增） |
| `arDueDate`          | L 列              | 应收账款到期日   | E7 起（按行递增） |
| `loanSerialNo`       | H 列              | 放款流水编号     | F7 起（按行递增） |
| `loanAmount`         | Q 列              | 放款金额         | G7 起（按行递增） |
| `financingDueDate`   | J 列              | 融资到期日       | H7 起（按行递增） |
| `repaymentAmount`    | I 列              | 融资余额         | I7 起（按行递增） |

> 说明：
>
> - “B7 起（按行递增）”表示第一条 transaction 对应模板的第 7 行，第二条对应第 8 行，依此类推；
> - 数值/日期类型的解析、格式化由实现方按模板格式要求处理（例如金额保留小数位、日期的显示格式等）。
